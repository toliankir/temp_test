<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test task</title>
  <link href="./public/style.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
  <div class="max-w-screen-xl mx-auto">
    <header class="px-2 border-b flex items-center justify-between h-14">
      <a class="uppercase font-bold text-purple-500" href="#">Test task</a>
    </header>
  </div>
  <div class="max-w-screen-xl mx-auto">
    <div class="flex p-3 justify-center">
      <div class="w-full sm:w-1/2 lg:w-1/3 inline-block">
        <form x-data>
          <div class="my-2">
            <label for="user_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Full
              name</label>
            <input x-model="$store.main.userName" type="text" id="user_name"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
              placeholder="John Doe" required />
          </div>

          <div class="my-2">
            <label for="user_email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label>
            <input x-model="$store.main.userEmail" type="text" id="user_email"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
              placeholder="test@mail.com" required />
          </div>

          <div class="my-2">
            <label for="user_phone" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Phone</label>
            <input x-model="$store.main.userPhone" type="text" id="user_phone"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
              placeholder="380661234567" required />
          </div>

          <div class="my-2">
            <label for="user_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Position</label>
            <button x-text="$store.main.positionStr" id="dropdownDefaultButton" data-dropdown-toggle="dropdown"
              class="text-white bg-purple-500 hover:bg-purple-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-800"
              type="button"> <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="m1 1 4 4 4-4" />
              </svg>
            </button>

            <!-- Dropdown menu -->
            <div id="dropdown"
              class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700">
              <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
                <template x-for="position in $store.main.positions">
                  <li x-on:click="$store.main.setPosition(position.id)">
                    <a x-text="position.name" href="#"
                      class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"></a>
                  </li>
                </template>
              </ul>
            </div>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="file_input">Upload
              file</label>
              <input x-on:change="$store.main.files = Object.values($event.target.files)"
              id="file_input"
              type="file"
              class="block w-full text-gray-900 text-sm
                  file:mr-4 file:py-2.5 file:px-5 file:rounded-lg
                  file:border-0 file:text-sm
                  file:bg-purple-500 file:text-white
                  hover:file:bg-puple-800"
            />
          </div>

          <div class="text-center mt-5 mb-2">
            <p class="bg-purple-500 hover:bg-purple-800 text-white hover:cursor-pointer inline-block px-5 py-2.5 font-semibold rounded-lg "
              x-on:click="$store.main.addUser()">Add user</p>
          </div>
        </form>
      </div>
    </div>

    <div x-data>
      <p class="text-purple-500 font-bold text-center">
        <span x-text="$store.main.users.length"></span> users of <span x-text="$store.main.totalUsers"></span>
      </p>
    </div>

    <template class="flex" x-data x-for="user in $store.main.users">
      <div class="w-full sm:w-1/2 lg:w-1/3 p-2 inline-block">
        <div class="p-2 bg-gray-100 rounded flex items-start">
          <img class="rounded-full" :src="user.photo">
          <div class="p-2">
            <p class="text-purple-500 font-semibold">
              <span x-text="user.id"></span>:<span x-text="user.name"></span>
            </p>
            <p class="text-sm font-semibold">
              <span x-text="user.position"></span>
              (<span x-text="user.positionId"></span>)
            </p>
            <p class="text-sm">Email: <span x-text="user.email"></span></p>
            <p class="text-sm">Phone: <span x-text="user.phone"></span></p>
          </div>
        </div>
      </div>
    </template>

    <div x-data>
      <p @click="$store.main.loadMoreUsers()" class="text-center text-purple-500 font-bold hover:cursor-pointer">Load
        more users</p>
    </div>
  </div>

</body>
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.store('main', {
      async init() {
        const [postionsRes, usersRes] = await Promise.all([
          fetch('https://temp-test.onrender.com/positions'),
          fetch('https://temp-test.onrender.com/users?offset=0&count=6')]);
        const [{ positions }, { users, totalUsers, links: { nextUrl } }] = await Promise.all([postionsRes.json(), usersRes.json()]);

        this.positions = positions;
        this.users = users;
        this.userNextUrl = nextUrl;
        this.totalUsers = totalUsers;
      },
      async loadMoreUsers() {
        if (this.userNextUrl === null) {
          return;
        }
        const usersRes = await fetch(this.userNextUrl);
        const { users, totalUsers, links: { nextUrl } } = await usersRes.json();

        this.users.push(...users);
        this.userNextUrl = nextUrl;
        this.totalUsers = totalUsers;
      },
      positions: [],
      users: [],
      totalUsers: 0,
      userNextUrl: null,
      position: null,
      files: [],
      userName: null,
      userEmail: null,
      userPhone: null,
      async addUser() {
        if (!this.userName || !this.userEmail || !this.userPhone || !this.position || this.files.length !== 1) {
          console.error("Fill all fields");
          return;
        }
        const data = new FormData();
        data.set('name', this.userName);
        data.append('email', this.userEmail);
        data.append('phone', this.userPhone);
        data.append('positionId', this.position);
        data.append('photo', this.files[0], this.files[0].name);

        const tokenRes = await fetch('https://temp-test.onrender.com/token');
        const { token } = await tokenRes.json();

        const addUserRes = await fetch('https://temp-test.onrender.com/users', {
          method: 'POST',
          headers: {
            token
          },
          body: data
        });

        this.init();
      },
      setPosition(position) {
        this.position = position;
      },
      get positionStr() {
        if (this.position === null) {
          return "Dropdown button";
        }
        return this.positions.find((e) => e.id === this.position)?.name || "Dropdown button";
      },
    })
  });

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>

</html>